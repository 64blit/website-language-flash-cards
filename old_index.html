<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Transitional Fluency Flashcards</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .card-container {
            perspective: 1000px;
            margin: 20px 0;
        }

        .flashcard {
            width: 100%;
            height: 300px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.15s, opacity 0.1s;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .front {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .back {
            background: linear-gradient(135deg, #26de81, #20bf6b);
            color: white;
            transform: rotateY(180deg);
        }

        .card-content {
            width: 100%;
        }

        .card-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .card-text {
            font-size: 18px;
            line-height: 1.4;
        }

        .example {
            font-style: italic;
            margin-top: 10px;
            opacity: 0.9;
        }

        .formula {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }

        .navigation {
            text-align: center;
            margin: 30px 0;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: white;
            color: #667eea;
        }

        .counter {
            color: white;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .difficulty-buttons {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .difficulty-buttons.show {
            display: block;
        }

        .diff-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .diff-btn.easy {
            background: rgba(39, 174, 96, 0.8);
            border-color: #27ae60;
        }

        .diff-btn.medium {
            background: rgba(241, 196, 15, 0.8);
            border-color: #f1c40f;
        }

        .diff-btn.hard {
            background: rgba(231, 76, 60, 0.8);
            border-color: #e74c3c;
        }

        .diff-btn:hover {
            transform: scale(1.05);
        }

        .control-buttons {
            text-align: center;
            margin: 20px 0;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            color: white;
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
        }

        .add-card-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .add-card-section.show {
            display: block;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            color: white;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-buttons {
            text-align: center;
            margin-top: 20px;
        }

        .form-btn {
            background: rgba(39, 174, 96, 0.8);
            color: white;
            border: 2px solid #27ae60;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-btn:hover {
            background: #27ae60;
            transform: scale(1.05);
        }

        .form-btn.cancel {
            background: rgba(231, 76, 60, 0.8);
            border-color: #e74c3c;
        }

        .form-btn.cancel:hover {
            background: #e74c3c;
        }

        .form-btn.edit {
            background: rgba(52, 152, 219, 0.8);
            border-color: #3498db;
        }

        .form-btn.edit:hover {
            background: #3498db;
        }

        .card-count {
            color: white;
            text-align: center;
            margin: 10px 0;
            font-size: 16px;
            opacity: 0.9;
        }

        .edit-mode-indicator {
            background: rgba(52, 152, 219, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üá™üá∏ Spanish Transitional Fluency Flashcards</h1>

        <div class="instructions">
            Click cards to flip ‚Ä¢ Rate difficulty after each card ‚Ä¢ Hard cards appear more often
        </div>

        <div class="control-buttons">
            <button class="control-btn" onclick="appState.shuffleDeck()">üîÄ Shuffle</button>
            <button class="control-btn" onclick="appState.resetProgress()">üîÑ Reset Progress</button>
            <button class="control-btn" onclick="appState.toggleStats()">üìä Stats</button>
            <button class="control-btn" onclick="appState.toggleAddCard()">‚ûï Add Card</button>
        </div>

        <div class="add-card-section" id="add-card-section">
            <div class="edit-mode-indicator" id="edit-mode-indicator" style="display: none;">
                ‚úèÔ∏è Editing Card
            </div>

            <h3 style="color: white; text-align: center; margin-bottom: 20px;" id="add-card-title">Add New Flashcard
            </h3>

            <div class="form-group">
                <label for="front-title-input">Front Title:</label>
                <input type="text" id="front-title-input" placeholder="e.g., WHAT: Present Obligation">
            </div>

            <div class="form-group">
                <label for="front-text-input">Front Text (HTML allowed):</label>
                <textarea id="front-text-input"
                    placeholder="e.g., How do you say 'I have to sleep'?<div class='formula'>TENER + QUE + unchanged verb</div>"></textarea>
            </div>

            <div class="form-group">
                <label for="back-title-input">Back Title:</label>
                <input type="text" id="back-title-input" placeholder="e.g., Tengo que dormir">
            </div>

            <div class="form-group">
                <label for="back-text-input">Back Text (HTML allowed):</label>
                <textarea id="back-text-input"
                    placeholder="e.g., <div class='formula'>Tengo + que + dormir</div><div class='example'>Tengo que dormir temprano</div>"></textarea>
            </div>

            <div class="form-buttons">
                <button class="form-btn" id="save-card-btn" onclick="appState.saveNewCard()">üíæ Save Card</button>
                <button class="form-btn cancel" onclick="appState.cancelEdit()">‚ùå Cancel</button>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            Easy: <span id="easy-count">0</span> | Medium: <span id="medium-count">0</span> | Hard: <span
                id="hard-count">0</span> | Unrated: <span id="unrated-count">24</span>
        </div>

        <div class="card-count">
            Total Cards: <span id="total-cards">24</span> | Custom Cards: <span id="custom-cards">0</span>
        </div>

        <div class="counter">
            Card <span id="current">1</span> of <span id="total">24</span>
        </div>

        <div class="card-container">
            <div class="flashcard" id="flashcard" onclick="appState.flipCard()">
                <div class="card-face front">
                    <div class="card-content">
                        <div class="card-title" id="front-title">Loading...</div>
                        <div class="card-text" id="front-text">Loading...</div>
                    </div>
                </div>
                <div class="card-face back">
                    <div class="card-content">
                        <div class="card-title" id="back-title">Loading...</div>
                        <div class="card-text" id="back-text">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-btn" onclick="appState.previousCard()">‚Üê Previous</button>
            <button class="nav-btn" onclick="appState.nextCard()">Next ‚Üí</button>
        </div>

        <div class="difficulty-buttons" id="difficulty-buttons">
            <div style="margin-bottom: 10px; color: white;">How was that card?</div>
            <button class="diff-btn easy" onclick="appState.rateCard('easy')">üòä Easy</button>
            <button class="diff-btn medium" onclick="appState.rateCard('medium')">ü§î Medium</button>
            <button class="diff-btn hard" onclick="appState.rateCard('hard')">üò∞ Hard</button>
        </div>
    </div>

    <script>
        // Vanilla JavaScript State Management with Persistence
        const createStore = (storeConfig) =>
        {
            let state = storeConfig.initialState;
            let subscribers = new Set();

            const setState = (newState) =>
            {
                const prevState = state;
                state = typeof newState === 'function' ? newState(prevState) : { ...prevState, ...newState };

                // Persist to localStorage if persist config exists
                if (storeConfig.persist)
                {
                    try
                    {
                        localStorage.setItem(storeConfig.persist.name, JSON.stringify(state));
                    } catch (error)
                    {
                        console.warn('Failed to persist state:', error);
                    }
                }

                // Notify subscribers
                subscribers.forEach(callback => callback(state, prevState));
            };

            const getState = () => state;

            const subscribe = (callback) =>
            {
                subscribers.add(callback);
                return () => subscribers.delete(callback);
            };

            // Load persisted state
            if (storeConfig.persist)
            {
                try
                {
                    const persistedState = localStorage.getItem(storeConfig.persist.name);
                    if (persistedState)
                    {
                        state = { ...state, ...JSON.parse(persistedState) };
                    }
                } catch (error)
                {
                    console.warn('Failed to load persisted state:', error);
                }
            }

            return { setState, getState, subscribe };
        };

        // Initial cards data
        const initialCards = [
            {
                front: { title: "WHAT: Present Obligation", text: "How do you say 'I have to eat'?<div class='formula'>TENER + QUE + unchanged verb</div>" },
                back: { title: "Tengo que comer", text: "<div class='formula'>Tengo + que + comer</div><div class='example'>Tengo que estudiar espa√±ol</div><div class='example'>Tienes que ir al trabajo</div>" },
                difficulty: null,
                timesShown: 0,
                id: 0
            },
            {
                front: { title: "WHAT: Past Obligation", text: "How do you say 'I had to study'?<div class='formula'>TEN√çA + QUE + unchanged verb</div>" },
                back: { title: "Ten√≠a que estudiar", text: "<div class='formula'>Ten√≠a + que + estudiar</div><div class='example'>Ten√≠a que comer antes</div><div class='example'>Ten√≠as que ir ayer</div>" },
                difficulty: null,
                timesShown: 0,
                id: 1
            },
            {
                front: { title: "WHAT: Future Plans", text: "How do you say 'I'm going to visit'?<div class='formula'>IR + A + unchanged verb</div>" },
                back: { title: "Voy a visitar", text: "<div class='formula'>Voy + a + visitar</div><div class='example'>Voy a comer despu√©s</div><div class='example'>Vas a estudiar ma√±ana</div>" },
                difficulty: null,
                timesShown: 0,
                id: 2
            },
            {
                front: { title: "WHAT: Past Future Plans", text: "How do you say 'I was going to go'?<div class='formula'>IBA + A + unchanged verb</div>" },
                back: { title: "Iba a ir", text: "<div class='formula'>Iba + a + ir</div><div class='example'>Iba a comer pero no pude</div><div class='example'>Ibas a estudiar ayer</div>" },
                difficulty: null,
                timesShown: 0,
                id: 3
            },
            {
                front: { title: "WHEN: After doing something", text: "How do you say 'after eating'?<div class='formula'>DESPU√âS + DE + unchanged verb</div>" },
                back: { title: "Despu√©s de comer", text: "<div class='formula'>Despu√©s + de + comer</div><div class='example'>Despu√©s de estudiar</div><div class='example'>Despu√©s de ir al trabajo</div>" },
                difficulty: null,
                timesShown: 0,
                id: 4
            },
            {
                front: { title: "WHEN: Before doing something", text: "How do you say 'before studying'?<div class='formula'>ANTES + DE + unchanged verb</div>" },
                back: { title: "Antes de estudiar", text: "<div class='formula'>Antes + de + estudiar</div><div class='example'>Antes de comer</div><div class='example'>Antes de ir a casa</div>" },
                difficulty: null,
                timesShown: 0,
                id: 5
            },
            {
                front: { title: "WHY: Purpose", text: "How do you say 'to focus' / 'in order to focus'?<div class='formula'>PARA + unchanged verb</div>" },
                back: { title: "Para enfocarme", text: "<div class='formula'>Para + enfocarme</div><div class='example'>Para estudiar mejor</div><div class='example'>Para poder ir</div>" },
                difficulty: null,
                timesShown: 0,
                id: 6
            },
            {
                front: { title: "Conjugation: TENER QUE (Present)", text: "Fill in: _____ que comer<br>Yo, T√∫, √âl/Ella" },
                back: { title: "Tengo, Tienes, Tiene", text: "<div class='example'>Yo tengo que comer</div><div class='example'>T√∫ tienes que estudiar</div><div class='example'>√âl tiene que ir</div>" },
                difficulty: null,
                timesShown: 0,
                id: 7
            },
            {
                front: { title: "Conjugation: TENER QUE (Past)", text: "Fill in: _____ que estudiar<br>Yo, T√∫, √âl/Ella" },
                back: { title: "Ten√≠a, Ten√≠as, Ten√≠a", text: "<div class='example'>Yo ten√≠a que estudiar</div><div class='example'>T√∫ ten√≠as que comer</div><div class='example'>Ella ten√≠a que ir</div>" },
                difficulty: null,
                timesShown: 0,
                id: 8
            },
            {
                front: { title: "Conjugation: IR A (Present)", text: "Fill in: _____ a visitar<br>Yo, T√∫, √âl/Ella" },
                back: { title: "Voy, Vas, Va", text: "<div class='example'>Yo voy a visitar</div><div class='example'>T√∫ vas a comer</div><div class='example'>√âl va a estudiar</div>" },
                difficulty: null,
                timesShown: 0,
                id: 9
            },
            {
                front: { title: "Conjugation: IR A (Past)", text: "Fill in: _____ a comer<br>Yo, T√∫, √âl/Ella" },
                back: { title: "Iba, Ibas, Iba", text: "<div class='example'>Yo iba a comer</div><div class='example'>T√∫ ibas a estudiar</div><div class='example'>Ella iba a ir</div>" },
                difficulty: null,
                timesShown: 0,
                id: 10
            },
            {
                front: { title: "Vocabulary: To study", text: "What's the Spanish infinitive?" },
                back: { title: "Estudiar", text: "<div class='example'>Tengo que estudiar</div><div class='example'>Voy a estudiar</div><div class='example'>Para estudiar mejor</div>" },
                difficulty: null,
                timesShown: 0,
                id: 11
            },
            {
                front: { title: "Vocabulary: To eat", text: "What's the Spanish infinitive?" },
                back: { title: "Comer", text: "<div class='example'>Tengo que comer</div><div class='example'>Despu√©s de comer</div><div class='example'>Para comer bien</div>" },
                difficulty: null,
                timesShown: 0,
                id: 12
            },
            {
                front: { title: "Vocabulary: To go", text: "What's the Spanish infinitive?" },
                back: { title: "Ir", text: "<div class='example'>Tengo que ir</div><div class='example'>Voy a ir</div><div class='example'>Antes de ir</div>" },
                difficulty: null,
                timesShown: 0,
                id: 13
            },
            {
                front: { title: "Vocabulary: To visit", text: "What's the Spanish infinitive?" },
                back: { title: "Visitar", text: "<div class='example'>Voy a visitar</div><div class='example'>Para visitar familia</div><div class='example'>Ten√≠a que visitar</div>" },
                difficulty: null,
                timesShown: 0,
                id: 14
            },
            {
                front: { title: "Vocabulary: To focus", text: "What's the Spanish infinitive?" },
                back: { title: "Enfocarme", text: "<div class='example'>Para enfocarme</div><div class='example'>Tengo que enfocarme</div><div class='example'>Voy a enfocarme</div>" },
                difficulty: null,
                timesShown: 0,
                id: 15
            },
            {
                front: { title: "Complete the sentence", text: "Tengo que estudiar _____ de comer para _____.<br>(after/to focus)" },
                back: { title: "despu√©s / enfocarme", text: "<div class='formula'>Tengo que estudiar despu√©s de comer para enfocarme</div><div class='example'>Perfect What + When + Why structure!</div>" },
                difficulty: null,
                timesShown: 0,
                id: 16
            },
            {
                front: { title: "Complete the sentence", text: "_____ a visitar _____ de ir al trabajo.<br>(I'm going/before)" },
                back: { title: "Voy / antes", text: "<div class='formula'>Voy a visitar antes de ir al trabajo</div><div class='example'>Using future plans + timing!</div>" },
                difficulty: null,
                timesShown: 0,
                id: 17
            },
            {
                front: { title: "Translate", text: "I had to eat after studying to have energy" },
                back: { title: "Ten√≠a que comer despu√©s de estudiar para tener energ√≠a", text: "<div class='example'>Past obligation + timing + purpose</div><div class='example'>Perfect transitional fluency!</div>" },
                difficulty: null,
                timesShown: 0,
                id: 18
            },
            {
                front: { title: "What + When + Why", text: "Create a sentence:<br>WHAT: have to study<br>WHEN: after eating<br>WHY: to focus" },
                back: { title: "Tengo que estudiar despu√©s de comer para enfocarme", text: "<div class='formula'>WHAT + WHEN + WHY</div><div class='example'>This is the master formula!</div>" },
                difficulty: null,
                timesShown: 0,
                id: 19
            },
            {
                front: { title: "Add contrast with PERO", text: "I have to study but I'm going to eat first" },
                back: { title: "Tengo que estudiar pero voy a comer primero", text: "<div class='example'>Using pero to connect ideas</div><div class='example'>Combines multiple structures!</div>" },
                difficulty: null,
                timesShown: 0,
                id: 20
            },
            {
                front: { title: "Past vs Present", text: "Change to past:<br>'Voy a comer para tener energ√≠a'" },
                back: { title: "Iba a comer para tener energ√≠a", text: "<div class='example'>Voy ‚Üí Iba</div><div class='example'>PARA + verb stays unchanged!</div>" },
                difficulty: null,
                timesShown: 0,
                id: 21
            },
            {
                front: { title: "Critical Rule", text: "What happens to verbs after PARA, QUE, A, and DE?" },
                back: { title: "They stay UNCHANGED", text: "<div class='formula'>para COMER (not 'como')</div><div class='formula'>que ESTUDIAR (not 'estudio')</div><div class='example'>This rule simplifies everything!</div>" },
                difficulty: null,
                timesShown: 0,
                id: 22
            },
            {
                front: { title: "Master Challenge", text: "I was going to study before eating but I had to work" },
                back: { title: "Iba a estudiar antes de comer pero ten√≠a que trabajar", text: "<div class='example'>Past future + timing + contrast + past obligation</div><div class='example'>You've mastered transitional fluency! üéâ</div>" },
                difficulty: null,
                timesShown: 0,
                id: 23
            }
        ];

        // Create the store
        const store = createStore({
            initialState: {
                cards: [ ...initialCards ],
                deck: [ ...initialCards ],
                currentCardIndex: 0,
                isFlipped: false,
                showingDifficultyButtons: false,
                statsVisible: false,
                addCardVisible: false,
                nextCardId: 24, // Start custom IDs after initial cards
                customCardCount: 0,
                editingCardId: null, // Track which card is being edited
                isEditMode: false
            },
            persist: {
                name: 'spanish-flashcards-state'
            }
        });

        // App state and actions
        const appState = {
            // Getters
            get state()
            {
                return store.getState();
            },

            get currentCard()
            {
                return this.state.deck[ this.state.currentCardIndex ];
            },

            // Actions
            updateCard()
            {
                const flashcard = document.getElementById('flashcard');
                flashcard.style.opacity = '0';

                const card = this.currentCard;
                if (!card) return;

                document.getElementById('front-title').innerHTML = card.front.title;
                document.getElementById('front-text').innerHTML = card.front.text;
                document.getElementById('back-title').innerHTML = card.back.title;
                document.getElementById('back-text').innerHTML = card.back.text +
                    (card.isCustom ? '<div style="margin-top: 15px; font-size: 12px; opacity: 0.7;"><button onclick="appState.editCard(' + card.id + ')" style="background: rgba(52, 152, 219, 0.8); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">‚úèÔ∏è Edit</button><button onclick="appState.deleteCustomCard(' + card.id + ')" style="background: rgba(231, 76, 60, 0.8); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">üóëÔ∏è Delete</button></div>' :
                        '<div style="margin-top: 15px; font-size: 12px; opacity: 0.7;"><button onclick="appState.editCard(' + card.id + ')" style="background: rgba(52, 152, 219, 0.8); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">‚úèÔ∏è Edit Original Card</button></div>');
                document.getElementById('current').textContent = this.state.currentCardIndex + 1;
                document.getElementById('total').textContent = this.state.deck.length;

                // Track that this card was shown
                const cardInOriginalSet = this.state.cards.find(c => c.id === card.id);
                if (cardInOriginalSet)
                {
                    cardInOriginalSet.timesShown++;
                }

                store.setState({
                    isFlipped: false,
                    showingDifficultyButtons: false
                });

                flashcard.classList.remove('flipped');
                document.getElementById('difficulty-buttons').classList.remove('show');

                setTimeout(() =>
                {
                    flashcard.style.opacity = '1';
                }, 50);

                this.updateStats();
            },

            flipCard()
            {
                const flashcard = document.getElementById('flashcard');
                flashcard.classList.toggle('flipped');

                const newFlipState = !this.state.isFlipped;
                store.setState({
                    isFlipped: newFlipState,
                    showingDifficultyButtons: newFlipState
                });

                const diffButtons = document.getElementById('difficulty-buttons');
                if (newFlipState)
                {
                    diffButtons.classList.add('show');
                } else
                {
                    diffButtons.classList.remove('show');
                }
            },

            rateCard(difficulty)
            {
                const card = this.currentCard;
                if (!card) return;

                // Update difficulty in original cards array
                const cardInOriginalSet = this.state.cards.find(c => c.id === card.id);
                if (cardInOriginalSet)
                {
                    cardInOriginalSet.difficulty = difficulty;
                }

                // Update difficulty in current deck
                card.difficulty = difficulty;

                // Instantly flip back to front and advance to next card
                const flashcard = document.getElementById('flashcard');
                flashcard.classList.remove('flipped');
                document.getElementById('difficulty-buttons').classList.remove('show');

                store.setState({
                    isFlipped: false,
                    showingDifficultyButtons: false
                });

                setTimeout(() =>
                {
                    this.nextCard();
                }, 100);
            },

            nextCard()
            {
                let newIndex = this.state.currentCardIndex;

                if (newIndex >= this.state.deck.length - 1)
                {
                    this.reshuffleDeck();
                    newIndex = 0;
                } else
                {
                    newIndex++;
                }

                store.setState({ currentCardIndex: newIndex });
                this.updateCard();
            },

            previousCard()
            {
                const newIndex = Math.max(0, this.state.currentCardIndex - 1);
                store.setState({ currentCardIndex: newIndex });
                this.updateCard();
            },

            shuffleDeck()
            {
                const newDeck = [ ...this.state.deck ];
                for (let i = newDeck.length - 1; i > 0; i--)
                {
                    const j = Math.floor(Math.random() * (i + 1));
                    [ newDeck[ i ], newDeck[ j ] ] = [ newDeck[ j ], newDeck[ i ] ];
                }

                store.setState({
                    deck: newDeck,
                    currentCardIndex: 0
                });
                this.updateCard();
            },

            reshuffleDeck()
            {
                const cards = this.state.cards;

                // Sort cards by difficulty priority
                const sortedCards = [ ...cards ].sort((a, b) =>
                {
                    const difficultyOrder = { 'hard': 0, 'medium': 1, 'easy': 2, null: 1.5 };
                    return difficultyOrder[ a.difficulty ] - difficultyOrder[ b.difficulty ];
                });

                // Group by difficulty
                const hardCards = sortedCards.filter(card => card.difficulty === 'hard');
                const mediumCards = sortedCards.filter(card => card.difficulty === 'medium' || card.difficulty === null);
                const easyCards = sortedCards.filter(card => card.difficulty === 'easy');

                // Shuffle each group
                this.shuffleArray(hardCards);
                this.shuffleArray(mediumCards);
                this.shuffleArray(easyCards);

                // Rebuild deck with frequency weighting
                const newDeck = [];

                // Add hard cards 3 times
                for (let i = 0; i < 3; i++)
                {
                    newDeck.push(...hardCards);
                }

                // Add medium cards 2 times
                for (let i = 0; i < 2; i++)
                {
                    newDeck.push(...mediumCards);
                }

                // Add easy cards 1 time
                newDeck.push(...easyCards);

                // Final shuffle
                this.shuffleArray(newDeck);

                store.setState({ deck: newDeck });
            },

            shuffleArray(array)
            {
                for (let i = array.length - 1; i > 0; i--)
                {
                    const j = Math.floor(Math.random() * (i + 1));
                    [ array[ i ], array[ j ] ] = [ array[ j ], array[ i ] ];
                }
            },

            resetProgress()
            {
                const resetCards = this.state.cards.map(card => ({
                    ...card,
                    difficulty: null,
                    timesShown: 0
                }));

                store.setState({
                    cards: resetCards,
                    deck: [ ...resetCards ],
                    currentCardIndex: 0
                });
                this.updateCard();
            },

            updateStats()
            {
                const stats = { easy: 0, medium: 0, hard: 0, unrated: 0 };

                this.state.cards.forEach(card =>
                {
                    if (card.difficulty === 'easy') stats.easy++;
                    else if (card.difficulty === 'medium') stats.medium++;
                    else if (card.difficulty === 'hard') stats.hard++;
                    else stats.unrated++;
                });

                document.getElementById('easy-count').textContent = stats.easy;
                document.getElementById('medium-count').textContent = stats.medium;
                document.getElementById('hard-count').textContent = stats.hard;
                document.getElementById('unrated-count').textContent = stats.unrated;
            },

            toggleStats()
            {
                const newVisibility = !this.state.statsVisible;
                store.setState({ statsVisible: newVisibility });

                const statsEl = document.getElementById('stats');
                statsEl.style.display = newVisibility ? 'block' : 'none';
            },

            toggleAddCard()
            {
                const newVisibility = !this.state.addCardVisible;
                store.setState({
                    addCardVisible: newVisibility,
                    isEditMode: false,
                    editingCardId: null
                });

                const addCardEl = document.getElementById('add-card-section');
                addCardEl.classList.toggle('show', newVisibility);

                // Update UI for add mode
                if (newVisibility)
                {
                    this.setFormMode('add');
                }

                // Clear form when closing
                if (!newVisibility)
                {
                    this.clearAddCardForm();
                }
            },

            setFormMode(mode)
            {
                const titleEl = document.getElementById('add-card-title');
                const saveBtn = document.getElementById('save-card-btn');
                const editIndicator = document.getElementById('edit-mode-indicator');

                if (mode === 'edit')
                {
                    titleEl.textContent = 'Edit Flashcard';
                    saveBtn.innerHTML = 'üíæ Update Card';
                    saveBtn.onclick = () => appState.updateCard();
                    editIndicator.style.display = 'block';
                } else
                {
                    titleEl.textContent = 'Add New Flashcard';
                    saveBtn.innerHTML = 'üíæ Save Card';
                    saveBtn.onclick = () => appState.saveNewCard();
                    editIndicator.style.display = 'none';
                }
            },

            editCard(cardId)
            {
                const card = this.state.cards.find(c => c.id === cardId);
                if (!card) return;

                // Populate form with card data
                document.getElementById('front-title-input').value = card.front.title;
                document.getElementById('front-text-input').value = card.front.text;
                document.getElementById('back-title-input').value = card.back.title;
                document.getElementById('back-text-input').value = card.back.text;

                // Set edit mode
                store.setState({
                    addCardVisible: true,
                    isEditMode: true,
                    editingCardId: cardId
                });

                // Show form and set edit mode
                document.getElementById('add-card-section').classList.add('show');
                this.setFormMode('edit');
            },

            updateCard()
            {
                const frontTitle = document.getElementById('front-title-input').value.trim();
                const frontText = document.getElementById('front-text-input').value.trim();
                const backTitle = document.getElementById('back-title-input').value.trim();
                const backText = document.getElementById('back-text-input').value.trim();

                // Validation
                if (!frontTitle || !frontText || !backTitle || !backText)
                {
                    alert('Please fill in all fields to update the card.');
                    return;
                }

                const cardId = this.state.editingCardId;

                // Update in cards array
                const newCards = this.state.cards.map(card =>
                {
                    if (card.id === cardId)
                    {
                        return {
                            ...card,
                            front: { title: frontTitle, text: frontText },
                            back: { title: backTitle, text: backText }
                        };
                    }
                    return card;
                });

                // Update in deck array
                const newDeck = this.state.deck.map(card =>
                {
                    if (card.id === cardId)
                    {
                        return {
                            ...card,
                            front: { title: frontTitle, text: frontText },
                            back: { title: backTitle, text: backText }
                        };
                    }
                    return card;
                });

                store.setState({
                    cards: newCards,
                    deck: newDeck,
                    addCardVisible: false,
                    isEditMode: false,
                    editingCardId: null
                });

                // Clear form and hide
                this.clearAddCardForm();
                document.getElementById('add-card-section').classList.remove('show');

                // Refresh current card if it's the one being edited
                if (this.currentCard && this.currentCard.id === cardId)
                {
                    this.updateCard();
                }

                alert('Card updated successfully!');
            },

            cancelEdit()
            {
                store.setState({
                    addCardVisible: false,
                    isEditMode: false,
                    editingCardId: null
                });

                document.getElementById('add-card-section').classList.remove('show');
                this.clearAddCardForm();
            },

            clearAddCardForm()
            {
                document.getElementById('front-title-input').value = '';
                document.getElementById('front-text-input').value = '';
                document.getElementById('back-title-input').value = '';
                document.getElementById('back-text-input').value = '';
            },

            saveNewCard()
            {
                const frontTitle = document.getElementById('front-title-input').value.trim();
                const frontText = document.getElementById('front-text-input').value.trim();
                const backTitle = document.getElementById('back-title-input').value.trim();
                const backText = document.getElementById('back-text-input').value.trim();

                // Validation
                if (!frontTitle || !frontText || !backTitle || !backText)
                {
                    alert('Please fill in all fields to create a card.');
                    return;
                }

                // Create new card
                const newCard = {
                    front: { title: frontTitle, text: frontText },
                    back: { title: backTitle, text: backText },
                    difficulty: null,
                    timesShown: 0,
                    id: this.state.nextCardId,
                    isCustom: true
                };

                // Add to cards array and deck
                const newCards = [ ...this.state.cards, newCard ];
                const newDeck = [ ...this.state.deck, newCard ];

                store.setState({
                    cards: newCards,
                    deck: newDeck,
                    nextCardId: this.state.nextCardId + 1,
                    customCardCount: this.state.customCardCount + 1,
                    addCardVisible: false,
                    isEditMode: false,
                    editingCardId: null
                });

                // Clear form and hide
                this.clearAddCardForm();
                document.getElementById('add-card-section').classList.remove('show');

                // Update UI
                this.updateStats();
                this.updateCardCounts();

                alert(`Card added successfully! Total cards: ${newCards.length}`);
            },

            updateCardCounts()
            {
                const totalCards = this.state.cards.length;
                const customCards = this.state.cards.filter(card => card.isCustom).length;

                document.getElementById('total-cards').textContent = totalCards;
                document.getElementById('custom-cards').textContent = customCards;

                // Update the card counter in navigation
                document.getElementById('total').textContent = this.state.deck.length;
            },

            deleteCustomCard(cardId)
            {
                if (!confirm('Are you sure you want to delete this custom card?'))
                {
                    return;
                }

                const newCards = this.state.cards.filter(card => card.id !== cardId);
                const newDeck = this.state.deck.filter(card => card.id !== cardId);

                // Adjust current index if needed
                let newIndex = this.state.currentCardIndex;
                if (newIndex >= newDeck.length && newDeck.length > 0)
                {
                    newIndex = newDeck.length - 1;
                } else if (newDeck.length === 0)
                {
                    newIndex = 0;
                }

                store.setState({
                    cards: newCards,
                    deck: newDeck,
                    currentCardIndex: newIndex,
                    customCardCount: newCards.filter(card => card.isCustom).length
                });

                this.updateCard();
                this.updateStats();
                this.updateCardCounts();
            }
        };

        // Keyboard navigation
        document.addEventListener('keydown', function (e)
        {
            if (e.key === 'ArrowRight' || e.key === ' ')
            {
                e.preventDefault();
                if (appState.state.showingDifficultyButtons)
                {
                    appState.nextCard();
                } else if (appState.state.isFlipped)
                {
                    appState.nextCard();
                } else
                {
                    appState.flipCard();
                }
            } else if (e.key === 'ArrowLeft')
            {
                e.preventDefault();
                if (!appState.state.showingDifficultyButtons)
                {
                    appState.previousCard();
                }
            } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown')
            {
                e.preventDefault();
                appState.flipCard();
            } else if (e.key === '1' && appState.state.showingDifficultyButtons)
            {
                e.preventDefault();
                appState.rateCard('easy');
            } else if (e.key === '2' && appState.state.showingDifficultyButtons)
            {
                e.preventDefault();
                appState.rateCard('medium');
            } else if (e.key === '3' && appState.state.showingDifficultyButtons)
            {
                e.preventDefault();
                appState.rateCard('hard');
            }
        });

        // Initialize the app
        appState.updateCard();
        appState.updateStats();
        appState.updateCardCounts();

        // Set initial visibility based on stored state
        document.getElementById('stats').style.display = appState.state.statsVisible ? 'block' : 'none';
        document.getElementById('add-card-section').classList.toggle('show', appState.state.addCardVisible);
    </script>
</body>

</html>
